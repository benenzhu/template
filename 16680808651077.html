

<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>
      
    l01 操作系统 mit 6.s081 - 
    
    </title>
    
    
    
    <link href="atom.xml" rel="alternate" title="" type="application/atom+xml">
    <link rel="stylesheet" href="asset/style.css">
    
</head>
  <body>




        <div id="wrapper">
            <header class="site-header">
                <div class="container">
                    <div class="site-title-wrapper">
                          <a class="button-square" href="index.html">
<svg class="svg-inline--fa fa-home fa-w-18" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="home" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" data-fa-i2svg=""><path fill="currentColor" d="M280.37 148.26L96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z"></path></svg>
                            </a>
                        
                         
                        
                        
                        
                        
                      
                      <a class="button-square" href="atom.xml" target="_blank" title="RSS">
                              <svg class="svg-inline--fa fa-rss fa-w-14" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="rss" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"></path></svg><!-- <i class="fas fa-rss fa-lg"></i> -->
                      </a>

              
                       
                         
                        
                    </div>

                    <ul class="site-nav">
                        
                    </ul>
                </div>
            </header>

            <div id="container">

 
<div class="container">
  <article class="post-container">
    <header class="post-header">
        <h1 class="post-title">l01 操作系统 mit 6.s081</h1>
        <p class="post-date">
                <span>Posted <time datetime="2022/11/10" itemprop="datePublished">2022/11/10</time></span>
            </p>
    </header>

    <div class="post-content clearfix">
<h3><a id="%E5%87%86%E5%A4%87%E8%B5%84%E6%96%99" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>准备资料:</h3>
<ul>
<li><a href="https://mit-public-courses-cn-translatio.gitbook.io/mit6-s081/">中文翻译站点</a></li>
<li>xv6 system pdf: <a href="https://pdos.csail.mit.edu/6.S081/2022/xv6/book-riscv-rev3.pdf">https://pdos.csail.mit.edu/6.S081/2022/xv6/book-riscv-rev3.pdf</a></li>
<li>作业布置: <a href="https://pdos.csail.mit.edu/6.828/2021/schedule.html">https://pdos.csail.mit.edu/6.828/2021/schedule.html</a></li>
</ul>
<h3><a id="%E8%A1%A5%E5%85%85%E8%B5%84%E6%96%99" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>补充资料:</h3>
<ul>
<li><a href="https://space.bilibili.com/1040264970/">xv6 操作系统的深入讲解</a></li>
<li>xv6 中文文档(<a href="https://th0ar.gitbooks.io/xv6-chinese/content/index.html">https://th0ar.gitbooks.io/xv6-chinese/content/index.html</a>)</li>
<li>xv6 关键源码逐行解读 + 整体架构分析(<a href="https://www.youtube.com/playlist?list=PLbtzT1TYeoMhTPzyTZboW_j7TPAnjv9XB">https://www.youtube.com/playlist?list=PLbtzT1TYeoMhTPzyTZboW_j7TPAnjv9XB</a>)</li>
<li>资料汇总: PKU(<a href="https://github.com/PKUFlyingPig/MIT6.S081-2020fall">https://github.com/PKUFlyingPig/MIT6.S081-2020fall</a>)</li>
<li><a href="https://zhuanlan.zhihu.com/p/567525198">如何生成 xv6 的 complie_commands.json</a>
<ul>
<li>直接 bear -- make qemu 即可, 好像是 clangd 的专用工具</li>
</ul>
</li>
</ul>
<h3><a id="purposes" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>Purposes</h3>
<ul>
<li>Abstract h/w</li>
<li>Multiplex 同时使用多个功能</li>
<li>Isolation: not interfere</li>
<li>Sharing: sometimes</li>
<li>Security</li>
<li>Performance</li>
<li>Range of Uses</li>
</ul>
<h3><a id="os-orgnazations" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>O/S Orgnazations</h3>
<ul>
<li><code>User Space</code>:   vi, cc, shell</li>
<li><code>Kernel Space</code>:  fs, process managers, Mem Alloc, Access Ctrl</li>
<li><code>Hardware</code>: RAM, CPU, Disk, Net,</li>
</ul>
<h2><a id="interfaces" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>Interfaces</h2>
<p>API for the kernel <code>syscalls</code></p>
<pre><code class="language-c++">fd = open(&quot;out&quot;, 1) \\ is equal to O_WRONLY ??
// ssize_t write(int fd, const void *buf, size_t nbyte);
write(fd, &quot;hello\n&quot;)
// fork();
pid = fork(); 
</code></pre>
<h2><a id="why-challenging-interesting" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>Why challenging &amp; interesting</h2>
<ul>
<li>unforgiving in kernel programming</li>
<li>tensions
<ul>
<li>efficient - abstract</li>
<li>Powerful - Simple API</li>
<li>Flexible - Security</li>
<li>多个因素形成的矛盾, 需要去克服掉</li>
</ul>
</li>
<li>Interacte with different APIs</li>
<li>Under the hood
<ul>
<li>is infrastructure itself, the OSs</li>
</ul>
</li>
</ul>
<h2><a id="calss-structure" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>Calss Structure</h2>
<p>web site &amp; PIAZZA<br />
Lectures:</p>
<ul>
<li>xv6 codes</li>
<li>papers</li>
<li>labs
<ul>
<li>hands on experiences</li>
<li>start early</li>
<li>many grades</li>
</ul>
</li>
</ul>
<h2><a id="syscalls" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>Syscalls</h2>
<p>all xv6 codes are easy to read<br />
some codes:<br />
<code>make</code><br />
<code>make clean</code></p>
<pre><code class="language-c++">// copy.c
// 不断循环从 0(stdin) 读取, 然后 write 到 1(stdout) 上去
int main(){
    char buf[64]; 
    while(1) {
        int n = read(0, buf, sizeof(buf));
        if( n&lt;= 0)
            break; 
        write(1, buf, n);
    }
    exit(0); 
}
</code></pre>
<pre><code class="language-c++">// read.c
// 如何创建新的 fd
int fd = open(&quot;output.txt&quot;, O_WRONLY | OCREATE); 
write(fd, &quot;ooo\n&quot;, 4); 

exit(0);
</code></pre>
<ul>
<li>fd is indexing into a little table inside the kernel</li>
<li>different process have different fd lists</li>
</ul>
<p>shell does some work, like: redirect I/O, exec cmds.</p>
<blockquote>
<p>Q: how to transfer to syscall?  如何陷入内核?</p>
</blockquote>
<p>ecall 函数好像是? 然后找出来具体的参数这些</p>
<pre><code class="language-c++">//fork.c 
int main(){
    int pid = fork(); 
    // 这个存在问题就是两个都运行的时候, 会交叠起来
    printf(&quot;fork() return %d\n&quot;, pid); 
    
    if(pid == 0)
        printf(&quot;child \n&quot;); 
    else 
        printf(&quot;parent\n&quot;);
    
    exit(0);
}
</code></pre>
<blockquote>
<p>Copy On Write happen when fork() calls</p>
</blockquote>
<pre><code class="language-c++">// exec.c
// how shell works, to use fork() and to exec the commands
// exec will keep the same dfs too
int main(){
    char *argv[] = {&quot;echo&quot;, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;, 0};
    
    exec(&quot;echo&quot;, argv);

    // this should not happen 
    printf(&quot;exec failed\n&quot;);
    exit(0);
}
</code></pre>
<pre><code class="language-c++">// forkexc.c: fork then exec the commands 
int pid = fork();
int status;
if(pid == 0){
    char *argv[] = {&quot;echo&quot;, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;, 0};
    //exec(&quot;aaaecho&quot;, argv);
    //     if that run will exit with 1
    exec(&quot;echo&quot;, argv&quot;);
    
    // blow will never reach 
    printf(&quot;exec failed\n&quot;);
    exit(1);
}else{
    printf(&quot;parent waiting\n&quot;);
    wait(&amp;status);
    printf(&quot;the child exited with status %d\n&quot;, status);
}
exit(0);
</code></pre>
<blockquote>
<p><code>wait</code> 等待子进程其中之一进行退出, 如果没有 child 的话, 会直接返回 -1</p>
</blockquote>
<h3><a id="%E5%A6%82%E4%BD%95%E7%BB%93%E5%90%88%E8%B5%B7%E6%9D%A5%E5%AE%9E%E7%8E%B0%E9%87%8D%E5%AE%9A%E5%90%91" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>如何结合起来实现重定向</h3>
<blockquote>
<p>fork 出来的子进程中, 关闭 1(stdout) 的fd, 然后打开新的文件就行</p>
</blockquote>
<pre><code class="language-c++">//redirect.c
int pid = fork(); 
if(pid == 0){
    close(1);
    // Open redirect to the minimum fd
    open(&quot;output.txt&quot;, O_WRONLY | O_CREATE);
    char *argv[] = {&quot;echo&quot;, &quot;a&quot;, &quot;b&quot;, &quot;c&quot;, 0};
    exec(&quot;echo&quot;, argv);
    printf(&quot;exec failed!\n&quot;);
} else {
    wait((int*) 0);
}
exit(0);
</code></pre>
<blockquote>
<p>why <code>fork</code> and <code>exec</code> are separate calls?</p>
</blockquote>
<p>give the shell a chance to redirect the I/O</p>
<blockquote>
<p><code>dup</code> in shell</p>
</blockquote>
<p><code>ls ... &gt; tmp1 2&gt;&amp;1</code> 中 <code>2&gt;&amp;1</code> 告诉shell去 重定向 stderr 到 stdout</p>
<pre><code class="language-c++">// testpipe.c: 测试管道的用法, 父进程和子进程交互, 同时重定向
int main(){
    int p[2];
    char *argv[2] = {&quot;wc&quot;, 0};
    pipe(p);  
    if(fork() == 0){
        close(0); // 关闭读
        dup(p[0]); // 复制管道的读端
        close(p[0]);
        close(p[1]); 
        exec(&quot;wc&quot;, argv); // 然后执行
    } else {
        close(p[0]);
        write(p[1], &quot;hello world\n&quot;, 12); // 写入
        close(p[1]);
    }
    exit(0); 
}

</code></pre>
<h3><a id="pipe" class="anchor" aria-hidden="true"><span class="octicon octicon-link"></span></a>pipe</h3>
<p><code>read()</code> 等待由任何的数据被写入了, 或者所有的写端口都已经关闭了.</p>
<blockquote>
<p>是一个阻塞函数</p>
</blockquote>
<blockquote>
<p>可以用 <code>mknod(&quot;name&quot;, int major, int minor)</code> 来创建一个设备文件</p>
</blockquote>
<p><code>inode</code> <code>links</code> <code>metadata</code><br />
<code>fstat()</code> 用了查看 inode 的信息<br />
<code>link('a', 'b')</code> 创建一个指向 a 的文件 b<br />
<code>unlink()</code> 从文件系统中移除文件, 如果是最后一个的话, 代表着删除文件</p>
<pre><code class="language-c++">// 如何创建一个临时文件, 然后之后删除他
fd = open(&quot;/tmp/xyz&quot;, O_CREATE|O_RDWR);
unlink(&quot;/tmp/xyz&quot;);
</code></pre>
<p>POSIX 标准规定了需要使用的 syscalls 的类型</p>
<p>.<br />
.<br />
.<br />
.<br />
.<br />
.<br />
.<br />
.<br />
.<br />
.<br />
.<br />
.<br />
.</p>

    </div>
    <footer class="post-footer clearfix">
      <p class="post-categories">
        <span>Categories:</span>
        
            <a href="%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0.html">课程笔记</span>, 
           
      </p>
        
    </footer>
     <div class="comments-wrap">
        <div class="share-comments">
          

          

          
        </div>
      </div><!-- end comments wrap -->
  </article>
 </div><!-- end-->



    <footer class="footer">
            <div class="container">
                <div class="site-footer-wrapper">
                        <a class="button-square" href="index.html">
<svg class="svg-inline--fa fa-home fa-w-18" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="home" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512" data-fa-i2svg=""><path fill="currentColor" d="M280.37 148.26L96 300.11V464a16 16 0 0 0 16 16l112.06-.29a16 16 0 0 0 15.92-16V368a16 16 0 0 1 16-16h64a16 16 0 0 1 16 16v95.64a16 16 0 0 0 16 16.05L464 480a16 16 0 0 0 16-16V300L295.67 148.26a12.19 12.19 0 0 0-15.3 0zM571.6 251.47L488 182.56V44.05a12 12 0 0 0-12-12h-56a12 12 0 0 0-12 12v72.61L318.47 43a48 48 0 0 0-61 0L4.34 251.47a12 12 0 0 0-1.6 16.9l25.5 31A12 12 0 0 0 45.15 301l235.22-193.74a12.19 12.19 0 0 1 15.3 0L530.9 301a12 12 0 0 0 16.9-1.6l25.5-31a12 12 0 0 0-1.7-16.93z"></path></svg>
                            </a>
                        
                         
                        
                        
                        
                        
                      
                      <a class="button-square" href="atom.xml" target="_blank" title="RSS">
                              <svg class="svg-inline--fa fa-rss fa-w-14" aria-hidden="true" focusable="false" data-prefix="fas" data-icon="rss" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" data-fa-i2svg=""><path fill="currentColor" d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"></path></svg><!-- <i class="fas fa-rss fa-lg"></i> -->
                      </a>

              
                       
                                                
                </div>
                <div class="site-menu-wrapper">
                  &nbsp;<span>|</span>&nbsp;
                  
                    <a target="_self" class="" href="index.html">Home</a>
                    &nbsp;<span>|</span>&nbsp;
                  
                    <a target="_self" class="" href="archives.html">Archives</a>
                    &nbsp;<span>|</span>&nbsp;
                                             
                </div>

                <p class="footer-copyright">
                        Copyright &copy; 2019
                        Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
                        Theme used <a target="_blank" href="https://blog.timac.org">Timac</a>.
                </p>
            </div>
        </footer>



  













<script src="asset/prism.js"></script>

        
      
  
    


    </body>
</html>
